<?php
	$repInclude = './include/';
  	require($repInclude . "_coDb.inc.php");
	//si l'utilisateur 
	
?>
<html>
<head>
	<title>Suivi des frais de visite</title>
	<style type="text/css">
		<!-- body {background-color: white; color:5599EE; } 
			.titre { width : 180 ;  clear:left; float:left; } 
			.zone { float : left; color:7091BB } -->
	</style>
</head>
<body>
<div name="gauche" style="clear:left:;float:left;width:18%; background-color:white; height:100%;">
<div name="coin" style="height:10%;text-align:center;"><img src="logo.jpg" width="100" height="60"/></div>
<div name="menu" >
	<h2>Outils</h2>
	<ul><li>Frais</li>
		<ul>
			<li><a href="formSaisieFrais.htm" >Nouveau</a></li>
			<li><a href="formConsultFrais.htm">Consulter</a></li>
		</ul>
	</ul>
</div>
</div>
<div name="droite" style="float:left;width:80%;">
	<div name="haut" style="margin: 2 2 2 2 ;height:10%;float:left;"><h1>Suivi de remboursement des Frais</h1></div>	
	<div name="bas" style="margin : 10 2 2 2;clear:left;background-color:77AADD;color:white;height:88%;">
		<h1> Période </h1>
			<form action="formConsultFrais.php" method="POST">
				<label class="titre">Année/Mois :</label> 
				<input class="zone" type="text" name="dateConsult" size="12" />	
				<input type="submit" class="bouton" value="Choisir une date" />
			</form>
		<p class="titre" />
		<div style="clear:left;"><h2>Frais au forfait </h2></div>
		<table style="color:white;" border="1">
			<tr><th>Repas midi</th><th>Nuitée </th><th>Etape</th><th>Km </th><th>Situation</th><th>Date opération</th></tr>
			<?php 
			if (isset($_POST['dateConsult'])) 
    	{
    		$dateConsult = $_POST['dateConsult'];

			$req1 = $bdd->prepare("SELECT mois, dateModif, idEtat 
								  FROM fichefrais
								  WHERE mois = :dateConsult");
			$req1->bindValue(":dateConsult", $dateConsult, PDO::PARAM_INT);
	    	$req1->execute();
	    	$resultat2 = $req1->fetchAll();
	    	foreach($resultat2 as $ligne2) 
			{
				$situation= $ligne2["idEtat"]; 
				$dateModif = $ligne2["dateModif"];
				$mois = $ligne2["mois"];

				if ($situation == 'CL')
				{
					$situation = 'Saisie cloturée';
				}
				if ($situation == 'CR')
				{
					$situation = 'Saisie en cours';
				}
				if ($situation == 'RB')
				{
					$situation = 'Remboursée';
				}
				if ($situation == 'VA')
				{
					$situation = 'Validée et mise en paiement';
				}

	    	$req2 = $bdd->prepare("SELECT (montant*quantite) as prix
										FROM lignefraisforfait LFF, fraisforfait FF
										WHERE LFF.idFraisForfait = FF.id
										ORDER BY LFF.idVisiteur");
	    	$req2->execute();
	    	$resultat = $req2->fetchAll();	
	    	$tableau = array();    
			
				foreach($resultat as $ligne) 
			{
				array_push($tableau, $ligne["prix"]);
    		}

			?>
			<tr align="center">
				<?php
					for()
				?>
				<td width="80"><label  size="3" name="repas"/><?php echo $tableau[3]; ?></td>
				<td width="80"><label size="3" name="nuitee"/><?php echo $tableau[2]; ?></td> 
				<td width="80"> <label size="3" name="etape"/><?php echo $tableau[0]; ?></td>
				<td width="80"> <label size="3" name="km" /><?php echo $tableau[1]; ?></td>
				<td width="80"> <label size="3" name="situation" /><?php echo $situation; ?></td>	
				<td width="80"> <label size="3" name="dateOper" /><?php echo  $dateModif; ?></td>					
			</tr>
			<?php
			
		}
		
		
			?>	
		</table>
		
		<p class="titre" /><div style="clear:left;"><h2>Hors Forfait</h2></div>
		<table style="color:white;" border="1">
			<tr><th>Date</th><th>Libellé </th><th>Montant</th><th>Situation</th><th>Date opération</th></tr>
			<?php 
			
				

				$req1 = $bdd->prepare("SELECT  libelle, date, montant, dateModif, idEtat, COUNT(nbJustificatifs)
								  FROM lignefraishorsforfait L, fichefrais F
								  WHERE L.idVisiteur = F.idVisiteur
								  AND F.mois = :dateConsult");
			$req1->bindValue(":dateConsult", $dateConsult, PDO::PARAM_INT);
	    	$req1->execute();
	    	$resultat1 = $req1->fetchAll();
	    	foreach($resultat1 as $ligne1) 
			{
				$libelle = $ligne1["libelle"];
				$date = $ligne1["date"];
				$montant = $ligne1["montant"];
				$situation1= $ligne1["idEtat"]; 
				$dateModif1 = $ligne1["dateModif"];
				$nbJustificatifs = $ligne1["nbJustificatifs"];
			?>
			<tr align="center"><td width="100" ><label size="12" name="hfDate1"/><?php echo $date;?></td>
				<td width="220"><label size="30" name="hfLib1"/><?php echo $libelle;?></td> 
				<td width="90" ><label size="10" name="hfMont1"/><?php echo $montant;?></td>
				<td width="80"> <label size="3" name="hfSitu1" /><?php echo $situation1;?></td>
				<td width="80"> <label size="3" name="hfDateOper1" /><?php echo $dateModif1;?></td>		
				</tr>
				<?php }}?>
		</table>	
		<p class="titre"></p>
		<div class="titre">Nb Justificatifs</div><input type="text" class="zone" size="4" name="hcMontant" value="<?php echo $nbJustificatifs;?>"/>
	</form>
	</div>
</div>
</body>
</html>
